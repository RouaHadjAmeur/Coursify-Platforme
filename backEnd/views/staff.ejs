<%- include('partials/head', { title: 'Admin Dashboard - Coursify' }) %>

    <%- include('partials/sidebar') %>

    <!-- Right column -->
    <div class="flex-1 flex flex-col">
      <!-- Topbar -->
     <header class="h-14 border-b border-black/5 bg-white flex items-center justify-between px-4">
  <div class="flex items-center gap-3">
    <h1 class="text-lg font-semibold text-gray-900">Admin Dashboard</h1>
  </div>

  <div class="flex items-center gap-3">
    <!-- Notifications -->
    <div class="relative">
      <button id="notificationBtn" class="grid place-items-center h-9 w-9 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
        üîî
        <span id="notificationBadgeTop" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
      </button>

      <!-- Notification dropdown -->
      <div id="notificationDropdown" class="hidden absolute right-0 top-12 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
        <div class="p-3 border-b border-gray-200">
          <h3 class="font-semibold text-gray-900">Notifications</h3>
        </div>
        <div id="notificationList" class="max-h-64 overflow-y-auto">
          <% const notificationPendingUsers = users ? users.filter(u => u.status === 'Pending') : []; %>
          <% if (notificationPendingUsers.length > 0) { %>
            <% notificationPendingUsers.forEach(user => { %>
              <div class="p-3 border-b border-gray-100 hover:bg-gray-50">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                    <span class="text-amber-600 text-sm">‚è≥</span>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">New staff member: <%= user.name %></p>
                    <p class="text-xs text-gray-500"><%= user.email %> - <%= user.role %></p>
                  </div>
                  <button onclick="approveUser('<%= user.id %>')" class="text-xs bg-green-500 text-white px-2 py-1 rounded">Approve</button>
                  <button onclick="rejectUser('<%= user.id %>')" class="text-xs bg-red-500 text-white px-2 py-1 rounded">Reject</button>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="p-3 text-center text-gray-500">
              No pending notifications
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Current User -->
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-600">Welcome,</span>
      <span id="currentUserName" class="text-sm font-semibold text-gray-900">Admin</span>
    </div>

    <button 
      onclick="logout()"
      class="px-3 py-1.5 text-sm font-semibold text-red-600 hover:bg-red-50 rounded-lg transition-colors"
    >
      Logout
    </button>
  </div>
</header>


      <main class="mx-auto w-full max-w-7xl p-4 md:p-6">
        <!-- Dashboard Content -->
        <div id="dashboardContent" class="space-y-6">
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-600">Total Users</p>
                  <p id="totalUsers" class="text-2xl font-bold text-gray-900"><%= users ? users.length : 0 %></p>
                </div>
                <div class="text-blue-500">üë•</div>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-600">Pending Approval</p>
                  <p id="pendingUsers" class="text-2xl font-bold text-amber-600"><%= users ? users.filter(u => u.status === 'Pending').length : 0 %></p>
                </div>
                <div class="text-amber-500">‚è≥</div>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-600">Active Users</p>
                  <p id="activeUsers" class="text-2xl font-bold text-green-600"><%= users ? users.filter(u => u.status === 'Active').length : 0 %></p>
                </div>
                <div class="text-green-500">‚úÖ</div>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-600">Rejected Users</p>
                  <p id="rejectedUsers" class="text-2xl font-bold text-red-600"><%= users ? users.filter(u => u.status === 'Rejected').length : 0 %></p>
                </div>
                <div class="text-red-500">‚ùå</div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="p-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
            </div>
            <div class="p-4">
              <div id="recentActivity" class="space-y-3">
                <!-- Recent activity will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Staff Management Content -->
        <div id="staffContent" class="hidden space-y-6">
          <!-- Status Messages -->
          <div id="statusMessage" class="hidden mb-4 p-3 rounded-lg text-sm"></div>
          
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900">Staff Management</h1>
            <div class="flex items-center gap-3">
              <div class="relative">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search staff..."
                  oninput="filterTable()"
                  class="w-64 rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-[#B0D0D3] focus:ring-2 focus:ring-[#B0D0D3]/20 outline-none"
                />
                <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <select
                id="statusFilter"
                onchange="filterTable()"
                class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-[#B0D0D3] focus:ring-2 focus:ring-[#B0D0D3]/20 outline-none"
              >
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Pending">Pending</option>
                <option value="Rejected">Rejected</option>
              </select>
              <button
                onclick="resetFilters()"
                class="rounded-lg bg-gray-100 px-3 py-2 text-sm text-gray-700 hover:bg-gray-200 transition-colors"
              >
                Reset
              </button>
            </div>
          </div>

          <div class="rounded-2xl border border-black/5 bg-white p-6 shadow-sm">
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="text-gray-500 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-4 font-semibold">Staff Member</th>
                    <th class="px-4 py-4 font-semibold">Contact Info</th>
                    <th class="px-4 py-4 font-semibold">Role & Status</th>
                    <th class="px-4 py-4 font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="staffTableBody" class="divide-y divide-gray-100">
                  <% if (users && users.length > 0) { %>
                    <% users.forEach(user => { %>
                      <tr class="hover:bg-gray-50/60" data-user-id="<%= user.id %>" data-status="<%= user.status %>">
                        <td class="px-4 py-4">
                          <div class="flex items-center gap-3">
                            <div class="grid h-10 w-10 place-items-center rounded-full bg-[#B0D0D3] text-sm font-semibold text-white">
                              <%= user.name.charAt(0).toUpperCase() %>
                            </div>
                            <div>
                              <div class="font-medium text-gray-900"><%= user.name %></div>
                              <div class="text-sm text-gray-500"><%= user.role %></div>
                            </div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="space-y-1">
                            <div class="text-gray-900"><%= user.email %></div>
                            <div class="text-sm text-gray-500"><%= user.contact || "No contact info" %></div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="space-y-2">
                            <% 
                              let statusClass = 'bg-gray-100 text-gray-700';
                              let statusText = 'Inactive';
                              switch(user.status) {
                                case 'Active':
                                  statusClass = 'bg-emerald-100 text-emerald-700';
                                  statusText = 'Active';
                                  break;
                                case 'Pending':
                                  statusClass = 'bg-amber-100 text-amber-800';
                                  statusText = 'Pending';
                                  break;
                                case 'Approved':
                                  statusClass = 'bg-blue-100 text-blue-700';
                                  statusText = 'Approved';
                                  break;
                                case 'Rejected':
                                  statusClass = 'bg-red-100 text-red-700';
                                  statusText = 'Rejected';
                                  break;
                              }
                            %>
                            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold <%= statusClass %>"><%= statusText %></span>
                            <div class="text-sm text-gray-500">Joined: <%= user.joined || "N/A" %></div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="flex items-center gap-2">
                            <button 
                              title="View Details" 
                              onclick="console.log('View button clicked for user:', '<%= user.id %>'); viewUser('<%= user.id %>');" 
                              data-user-id="<%= user.id %>"
                              class="group relative p-2.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-200"
                            >
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                              </svg>
                              <span class="absolute -top-2 -right-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                View
                              </span>
                            </button>
                            <button 
                              title="Edit User" 
                              onclick="editUser('<%= user.id %>')" 
                              class="group relative p-2.5 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                            >
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                              </svg>
                              <span class="absolute -top-2 -right-2 bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                Edit
                              </span>
                            </button>
                            <button 
                              title="Delete User" 
                              onclick="deleteUser('<%= user.id %>')" 
                              class="group relative p-2.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-200"
                            >
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                              <span class="absolute -top-2 -right-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                Delete
                              </span>
                            </button>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center gap-2">
                          <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                          </svg>
                          <p class="text-lg font-medium">No staff members found</p>
                          <p class="text-sm">Staff members will appear here once they are added to the system.</p>
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- New Staff Content -->
        <div id="newStaffContent" class="hidden space-y-6">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">New Staff Approval</h1>
              <p class="text-gray-600 mt-1">Review and approve new staff member applications</p>
            </div>
          </div>

          <div class="rounded-2xl border border-black/5 bg-white p-6 shadow-sm">
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="text-gray-500 border-b border-gray-200">
                  <tr>
                    <th class="px-4 py-4 font-semibold">Applicant</th>
                    <th class="px-4 py-4 font-semibold">Contact Details</th>
                    <th class="px-4 py-4 font-semibold">Application Info</th>
                    <th class="px-4 py-4 font-semibold">Review Actions</th>
                  </tr>
                </thead>
                <tbody id="newStaffTableBody" class="divide-y divide-gray-100">
                  <% 
                    const newStaffPendingUsers = users ? users.filter(u => u.status === 'Pending') : [];
                    if (newStaffPendingUsers.length > 0) { 
                  %>
                    <% newStaffPendingUsers.forEach(user => { %>
                      <tr class="hover:bg-gray-50/60" data-user-id="<%= user.id %>">
                        <td class="px-4 py-4">
                          <div class="flex items-center gap-3">
                            <div class="grid h-10 w-10 place-items-center rounded-full bg-amber-100 text-sm font-semibold text-amber-800">
                              <%= user.name.charAt(0).toUpperCase() %>
                            </div>
                            <div>
                              <div class="font-medium text-gray-900"><%= user.name %></div>
                              <div class="text-sm text-gray-500"><%= user.role %></div>
                            </div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="space-y-1">
                            <div class="text-gray-900"><%= user.email %></div>
                            <div class="text-sm text-gray-500"><%= user.contact || "No contact info" %></div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="space-y-2">
                            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold bg-amber-100 text-amber-800">Pending</span>
                            <div class="text-sm text-gray-500">Applied: <%= user.joined || "N/A" %></div>
                          </div>
                        </td>
                        <td class="px-4 py-4">
                          <div class="flex items-center gap-2">
                            <button 
                              onclick="approveUser('<%= user.id %>')" 
                              class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                              </svg>
                              Approve
                            </button>
                            <button 
                              onclick="rejectUser('<%= user.id %>')" 
                              class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                              </svg>
                              Reject
                            </button>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center gap-2">
                          <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                          </svg>
                          <p class="text-lg font-medium">No pending applications</p>
                          <p class="text-sm">New staff applications will appear here for review.</p>
                        </div>
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>


  <!-- VIEW USER Modal -->
<div id="viewUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" aria-hidden="true">
  <div id="viewUserModalCard" class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
    <div class="flex items-start justify-between mb-4 gap-4">
      <div class="flex items-center gap-4">
        <div id="viewUserAvatar" class="grid h-16 w-16 place-items-center rounded-full bg-slate-100 text-xl font-semibold text-slate-700 border">
          U
        </div>
        <div>
          <h3 id="viewUserName" class="text-xl font-semibold text-gray-900"></h3>
          <div id="viewUserRoleSmall" class="text-sm text-gray-500 mt-1"></div>
        </div>
      </div>

      <button id="closeViewUserBtn" onclick="closeViewUserModal()" class="text-gray-400 hover:text-gray-600 transition-colors" aria-label="Close view user">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>

    <div class="grid grid-cols-1 gap-3">
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Email</label>
        <div id="viewUserEmail" class="text-sm text-gray-800"></div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Contact</label>
        <div id="viewUserContact" class="text-sm text-gray-800"></div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Role</label>
          <div id="viewUserRole" class="text-sm text-gray-800"></div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Status</label>
          <div id="viewUserStatus" class="text-sm text-gray-800"></div>
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Joined</label>
        <div id="viewUserJoined" class="text-sm text-gray-800"></div>
      </div>

      <div id="viewUserExtra" class="text-sm text-gray-700"></div>

      <div class="pt-4 flex justify-end gap-2">
        <button id="viewEditBtn" type="button" onclick="" class="px-4 py-2 rounded-lg bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600">Edit</button>
        <button id="viewDeleteBtn" type="button" onclick="" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-800 text-sm font-medium hover:bg-gray-400">Delete</button>
      </div>
    </div>
  </div>
</div>



  <!-- Edit User Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold mb-4">Edit User</h3>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editUserId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
          <input type="text" id="editFirstName" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
          <input type="text" id="editLastName" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="editEmail" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
          <input type="text" id="editContact" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
          <select id="editRole" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
            <option value="Student">Student</option>
            <option value="instructor">instructor</option>
            <option value="Admin">Admin</option>
            <option value="Manager">Manager</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="editStatus" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Active">Active</option>
          </select>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-emerald-500 text-white py-2 rounded-lg text-sm font-semibold hover:bg-emerald-600">
            Update
          </button>
          <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg text-sm font-semibold hover:bg-gray-400">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Server-side data -->
  <script>
    window.serverUsers = [];
    try {
      window.serverUsers = JSON.parse('<%- JSON.stringify(users || []) %>');
    } catch (e) {
      console.log('No server-side users data available');
    }

    // Initialize currentUser from server-rendered data
    window.serverCurrentUser = null;
    try {
      <% if (typeof currentUser !== 'undefined' && currentUser) { %>
        window.serverCurrentUser = JSON.parse('<%- JSON.stringify(currentUser) %>');
      <% } %>
    } catch (e) {
      console.log('No server-side current user data available');
    }
  </script>

  <script>
    // Initialize currentUser from server-rendered data first
    let currentUser = window.serverCurrentUser || null;
    let allUsers = [];

    // Escape HTML function - must be defined early
    function escapeHtml(str) {
      if (typeof str === 'undefined' || str === null) return '';
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#039;");
    }
    // Make it globally accessible
    window.escapeHtml = escapeHtml;

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // If currentUser is already set from server, use it
      if (currentUser) {
        document.getElementById('currentUserName').textContent = currentUser.name || 'Admin';
      } else {
        // Otherwise, try to load from API
        loadCurrentUser();
      }
      loadDashboardData();
      setupNavigation();
      setupNotifications();
      
      // Add event delegation for view buttons (fallback for dynamically created buttons)
      const staffTableBody = document.getElementById('staffTableBody');
      if (staffTableBody) {
        staffTableBody.addEventListener('click', function(e) {
          const viewBtn = e.target.closest('button[data-user-id]');
          if (viewBtn && viewBtn.title === 'View Details') {
            const userId = viewBtn.getAttribute('data-user-id');
            console.log('Event delegation: View button clicked for user:', userId);
            if (userId && typeof viewUser === 'function') {
              viewUser(userId);
            } else {
              console.error('viewUser function not available or userId missing');
            }
          }
        });
      }
    });

    
    // Load current user (fallback if not set from server)
    async function loadCurrentUser() {
      // If already set from server, skip
      if (currentUser) {
        return;
      }

      try {
        const response = await fetch('/api/auth/status', {
          credentials: 'include'
        });
        const data = await response.json();
        
        if (data.isAuthenticated && data.user) {
          currentUser = data.user;
          document.getElementById('currentUserName').textContent = currentUser.name || 'Admin';
        } else {
          // Don't redirect to login, just show as not authenticated
          console.log('No authenticated user found');
          document.getElementById('currentUserName').textContent = 'Not Authenticated';
        }
      } catch (error) {
        console.error('Error loading current user:', error);
        document.getElementById('currentUserName').textContent = 'Error Loading User';
      }
    }

    // Load dashboard data from API (fresh data)
    async function loadDashboardData() {
      try {
        // Fetch fresh data from API
        const response = await fetch('/api/auth/users', {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const usersData = await response.json();
          // Handle both array response and object with users property
          const users = Array.isArray(usersData) ? usersData : (usersData.users || []);
          
          // Update allUsers with fresh data
          allUsers = users;
          
          // Update the UI with fresh data
          updateDashboardStats(users);
          updateNotifications(users);
          updateStaffTable(users);
          updateNewStaffTable(users);
        } else {
          // Fallback to server-side data if API fails
          const users = window.serverUsers || [];
          allUsers = users;
          updateDashboardStats(users);
          updateNotifications(users);
          updateStaffTable(users);
          updateNewStaffTable(users);
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Fallback to server-side data on error
        const users = window.serverUsers || [];
        allUsers = users;
        updateDashboardStats(users);
        updateNotifications(users);
        updateStaffTable(users);
        updateNewStaffTable(users);
      }
    }
// Dashboard stats
function updateDashboardStats(users) {
  const totalUsers = users.length;
  const pendingUsers = users.filter(u => u.status === 'Pending').length;
  const activeUsers = users.filter(u => u.status === 'Active').length;
  const rejectedUsers = users.filter(u => u.status === 'Rejected').length;

  document.getElementById('totalUsers').textContent = totalUsers;
  document.getElementById('pendingUsers').textContent = pendingUsers;
  document.getElementById('activeUsers').textContent = activeUsers;
  document.getElementById('rejectedUsers').textContent = rejectedUsers;

  // Update sidebar notification badge with unread count
  const pendingUsersList = users.filter(u => u.status === 'Pending');
  const unreadNotifications = getUnreadNotifications ? getUnreadNotifications(pendingUsersList) : pendingUsersList;
  const unreadCount = unreadNotifications.length;
  const countText = unreadCount > 99 ? '99+' : unreadCount.toString();
  
  const sidebarBadge = document.getElementById('notificationCount');
  if (sidebarBadge) {
    if (unreadCount > 0) {
      sidebarBadge.textContent = countText;
      sidebarBadge.classList.remove('hidden');
    } else {
      sidebarBadge.classList.add('hidden');
    }
  }
}

    // Update staff table dynamically
    function updateStaffTable(users) {
  const tbody = document.getElementById('staffTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  users.forEach(user => {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50/60';
    row.setAttribute('data-user-id', user.id);
    row.setAttribute('data-status', user.status);

    const statusClass = getStatusClass(user.status);
    const statusText = getStatusText(user.status);

    

    row.innerHTML = `
      <td class="px-4 py-4">
        <div class="flex items-center gap-3">
          <div class="grid h-10 w-10 place-items-center rounded-full bg-[#B0D0D3] text-sm font-semibold text-white">
            ${user.name.charAt(0).toUpperCase()}
          </div>
          <div>
            <div class="font-medium text-gray-900">${user.name}</div>
            <div class="text-sm text-gray-500">${user.role}</div>
          </div>
        </div>
      </td>
      <td class="px-4 py-4">
        <div class="space-y-1">
          <div class="text-gray-900">${user.email}</div>
          <div class="text-sm text-gray-500">${user.contact || "No contact info"}</div>
        </div>
      </td>
      <td class="px-4 py-4">
        <div class="space-y-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${statusClass}">${statusText}</span>
          <div class="text-sm text-gray-500">Joined: ${user.joined || "N/A"}</div>
        </div>
      </td>
      <td class="px-4 py-4">
        <div class="flex items-center gap-2">
          <button 
            title="View Details" 
            onclick="console.log('View button clicked for user:', '${user.id}'); viewUser('${user.id}');" 
            class="group relative p-2.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-200"
            data-user-id="${user.id}"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span class="absolute -top-2 -right-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              View
            </span>
          </button>
          <button 
            title="Edit User" 
            onclick="editUser('${user.id}')" 
            class="group relative p-2.5 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-200"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span class="absolute -top-2 -right-2 bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              Edit
            </span>
          </button>
          <button 
            title="Delete User" 
            onclick="deleteUser('${user.id}')" 
            class="group relative p-2.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-200"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            <span class="absolute -top-2 -right-2 bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              Delete
            </span>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}
    // Update new staff table dynamically
   function updateNewStaffTable(users) {
  const tbody = document.getElementById('newStaffTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const pendingUsers = users.filter(u => u.status === 'Pending');
  if (pendingUsers.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">No pending applications</td></tr>`;
    return;
  }

  pendingUsers.forEach(user => {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50/60';
    row.innerHTML = `
      <td class="px-4 py-4">${user.name}</td>
      <td class="px-4 py-4">${user.email}</td>
      <td class="px-4 py-4"><span class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs">Pending Review</span></td>
      <td class="px-4 py-4">
        <button onclick="approveUser('${user.id}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">Approve</button>
        <button onclick="rejectUser('${user.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">Reject</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

  // Get read notifications from localStorage
  function getReadNotifications() {
    try {
      const read = localStorage.getItem('readNotifications');
      return read ? JSON.parse(read) : [];
    } catch (e) {
      return [];
    }
  }
  
  // Filter unread notifications
  function getUnreadNotifications(pendingUsers) {
    const read = getReadNotifications();
    return pendingUsers.filter(user => !read.includes(user.id));
  }
  
  // Clean up read notifications for users that are no longer pending
  function cleanupReadNotifications(allUsers) {
    try {
      const read = getReadNotifications();
      const pendingUserIds = allUsers
        .filter(u => u.status === 'Pending')
        .map(u => u.id);
      
      // Remove read notifications for users who are no longer pending
      const cleanedRead = read.filter(userId => pendingUserIds.includes(userId));
      
      if (cleanedRead.length !== read.length) {
        localStorage.setItem('readNotifications', JSON.stringify(cleanedRead));
      }
    } catch (e) {
      console.error('Error cleaning up read notifications:', e);
    }
  }

  // Update notifications dynamically
function updateNotifications(users) {
  // Clean up read notifications for users no longer pending
  cleanupReadNotifications(users);
  
  const pendingUsers = users.filter(u => u.status === 'Pending');
  const unreadNotifications = getUnreadNotifications(pendingUsers);
  const unreadCount = unreadNotifications.length;
  const countText = unreadCount > 99 ? '99+' : unreadCount.toString();
  
  // Update navbar badge
  const notificationBadge = document.getElementById('notificationBadgeTop');
  if (notificationBadge) {
    if (unreadCount > 0) {
      notificationBadge.textContent = countText;
      notificationBadge.classList.remove('hidden');
    } else {
      notificationBadge.classList.add('hidden');
    }
  }
  
  // Update sidebar badge
  const sidebarBadge = document.getElementById('notificationCount');
  if (sidebarBadge) {
    if (unreadCount > 0) {
      sidebarBadge.textContent = countText;
      sidebarBadge.classList.remove('hidden');
    } else {
      sidebarBadge.classList.add('hidden');
    }
  }
  
  const notificationList = document.getElementById('notificationList');

  // Update notification list
  if (notificationList) {
    notificationList.innerHTML = ''; // clear current list

    if (pendingUsers.length > 0) {
      pendingUsers.forEach(user => {
        const notification = document.createElement('div');
        notification.className = 'p-3 border-b border-gray-100 hover:bg-gray-50';
        notification.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
              <span class="text-amber-600 text-sm">‚è≥</span>
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">New staff member: ${user.name}</p>
              <p class="text-xs text-gray-500">${user.email} - ${user.role}</p>
            </div>
            <button onclick="approveUser('${user.id}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded">Approve</button>
            <button onclick="rejectUser('${user.id}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded">Reject</button>
          </div>
        `;
        notificationList.appendChild(notification);
      });
    } else {
      notificationList.innerHTML = `
        <div class="p-3 text-center text-gray-500">
          No pending notifications
        </div>
      `;
    }
  }
}


    // Helper functions for status
  function getStatusClass(status) {
  switch (status) {
    case 'Active': return 'bg-emerald-100 text-emerald-700';
    case 'Pending': return 'bg-amber-100 text-amber-800';
    case 'Approved': return 'bg-blue-100 text-blue-700';
    case 'Rejected': return 'bg-red-100 text-red-700';
    default: return 'bg-gray-100 text-gray-700';
  }
}
    function getStatusText(status) {
  switch (status) {
    case 'Active': return 'Active';
    case 'Pending': return 'Pending';
    case 'Approved': return 'Approved';
    case 'Rejected': return 'Rejected';
    default: return 'Inactive';
  }
}
    // Setup navigation
    function setupNavigation() {
      const path = window.location.pathname;
      
      if (path === '/') {
        showDashboard();
      } else if (path === '/staff') {
        showStaffManagement();
      } else if (path === '/new-staff') {
        showNewStaff();
      }
    }

    // Show dashboard
    function showDashboard() {
      document.getElementById('dashboardContent').classList.remove('hidden');
      document.getElementById('staffContent').classList.add('hidden');
      document.getElementById('newStaffContent').classList.add('hidden');
    }

    // Show staff management
    function showStaffManagement() {
      document.getElementById('dashboardContent').classList.add('hidden');
      document.getElementById('staffContent').classList.remove('hidden');
      document.getElementById('newStaffContent').classList.add('hidden');
    }

    // Show new staff
    function showNewStaff() {
      document.getElementById('dashboardContent').classList.add('hidden');
      document.getElementById('staffContent').classList.add('hidden');
      document.getElementById('newStaffContent').classList.remove('hidden');
    }

   // Setup notifications dropdown
function setupNotifications() {
  const notificationBtn = document.getElementById('notificationBtn');
  const notificationDropdown = document.getElementById('notificationDropdown');

  if (!notificationBtn || !notificationDropdown) return;

  // Toggle dropdown on button click
  notificationBtn.addEventListener('click', async (e) => {
    e.stopPropagation(); // Prevent the document click from immediately closing it
    const isOpening = notificationDropdown.classList.contains('hidden');
    notificationDropdown.classList.toggle('hidden');

    // Refresh notifications when dropdown is opened
    if (isOpening && !notificationDropdown.classList.contains('hidden')) {
      await loadDashboardData(); // ensure this updates the notification list and badge
      
      // Mark all visible notifications as read when dropdown is opened
      const read = getReadNotifications();
      const pendingUsers = allUsers.filter(u => u.status === 'Pending');
      let hasNewRead = false;
      
      pendingUsers.forEach(user => {
        if (!read.includes(user.id)) {
          read.push(user.id);
          hasNewRead = true;
        }
      });
      
      if (hasNewRead) {
        localStorage.setItem('readNotifications', JSON.stringify(read));
        // Reload to update badge counts
        await loadDashboardData();
      }
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
      notificationDropdown.classList.add('hidden');
    }
  });

  // Optional: close dropdown on Escape key press
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      notificationDropdown.classList.add('hidden');
    }
  });
}


    // Logout function
    async function logout() {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          window.location.href = 'http://localhost:5173/login';
        } else {
          alert('Error logging out');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out');
      }
    }

    // Filter table function
    function filterTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const rows = document.querySelectorAll('#staffTableBody tr');

      rows.forEach(row => {
        const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const contact = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const status = row.getAttribute('data-status');

        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm) || contact.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
      });
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      filterTable();
    }




    // Edit user
    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      
      document.getElementById('editUserId').value = userId;
      document.getElementById('editFirstName').value = user.firstName || user.name.split(' ')[0] || '';
      document.getElementById('editLastName').value = user.lastName || user.name.split(' ').slice(1).join(' ') || '';
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editContact').value = user.contact || '';
      document.getElementById('editRole').value = user.role;
      document.getElementById('editStatus').value = user.status;
      
      document.getElementById('editModal').classList.remove('hidden');
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }
    // Make it globally accessible
    window.closeEditModal = closeEditModal;

    // Update user with automatic refresh
    function setupEditForm() {
      const editForm = document.getElementById('editForm');
      if (!editForm) {
        console.error('editForm not found');
        return;
      }

      // Remove existing listener to avoid duplicates
      const newForm = editForm.cloneNode(true);
      editForm.parentNode.replaceChild(newForm, editForm);

      // Re-attach event listener to the new form
      document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Edit form submitted');
        
        const userId = document.getElementById('editUserId').value;
        if (!userId) {
          alert('Error: No user ID found');
          return;
        }

        const formData = {
          firstName: document.getElementById('editFirstName').value.trim(),
          lastName: document.getElementById('editLastName').value.trim(),
          email: document.getElementById('editEmail').value.trim(),
          contact: document.getElementById('editContact').value.trim(),
          role: document.getElementById('editRole').value,
          status: document.getElementById('editStatus').value
        };

        console.log('Updating user:', userId, formData);

        try {
          const response = await fetch(`/api/auth/users/${userId}`, {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json', 
              ...(currentUser ? { 'x-user-id': currentUser.id } : {}) 
            },
            credentials: 'include',
            body: JSON.stringify(formData)
          });

          console.log('Update response status:', response.status);

          if (response.ok) {
            const result = await response.json();
            console.log('Update successful:', result);
            showStatusMessage('User updated successfully');
            closeEditModal();
            // Automatically update dashboard data immediately
            await loadDashboardData();
          } else {
            const data = await response.json().catch(() => ({ message: 'Unknown error' }));
            console.error('Update failed:', data);
            showStatusMessage(data.message || 'Error updating user', 'error');
            alert('Failed to update user: ' + (data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error updating user:', error);
          showStatusMessage('Error updating user: ' + error.message, 'error');
          alert('Error updating user: ' + error.message);
        }
      });
    }

    // Setup edit form when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupEditForm);
    } else {
      setupEditForm();
    }

    // Delete user with automatic refresh
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
      
      try {
        const response = await fetch(`/api/auth/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: { ...(currentUser ? { 'x-user-id': currentUser.id } : {}) }
        });

        if (response.ok) {
          showStatusMessage('User deleted successfully');
          // Automatically update dashboard data immediately
          await loadDashboardData();
        } else {
          const data = await response.json();
          showStatusMessage(data.message || 'Error deleting user', 'error');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        showStatusMessage('Error deleting user', 'error');
      }
    }

 

    async function approveUser(userId) {
    await updateUserStatus(userId, "Approved");
  }

  async function rejectUser(userId) {
    await updateUserStatus(userId, "Rejected");
  }

async function updateUserStatus(userId, status) {
  // Mark notification as read when action is taken
  try {
    const read = getReadNotifications();
    if (!read.includes(userId)) {
      read.push(userId);
      localStorage.setItem('readNotifications', JSON.stringify(read));
    }
  } catch (e) {
    console.error('Error marking notification as read:', e);
  }
  
  // Ensure current user is loaded - try server data first, then API
  if (!currentUser) {
    // Try to get from server-rendered data first
    if (window.serverCurrentUser) {
      currentUser = window.serverCurrentUser;
      document.getElementById('currentUserName').textContent = currentUser.name || 'Admin';
    } else {
      // Fallback to API call
      await loadCurrentUser();
      if (!currentUser) {
        return alert("Cannot identify current admin user. Please refresh the page.");
      }
    }
  }

  try {
    const response = await fetch("/api/auth/users/status", {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...(currentUser ? { 'x-user-id': currentUser.id } : {}) },
      credentials: 'include',
      body: JSON.stringify({ userId, status, approvedBy: currentUser.id })
    });

    const data = await response.json();

    if (response.ok) {
      // Refresh data from server to ensure consistency
      await loadDashboardData();
      showStatusMessage(`User ${status.toLowerCase()} successfully`, "success");
    } else {
      showStatusMessage(data.message || "Failed to update status", "error");
    }
  } catch (err) {
    console.error(err);
    showStatusMessage("Error updating user status", "error");
  }
}
  

  function showStatusMessage(message, type = "success") {
  const msgEl = document.getElementById("statusMessage");
  if (!msgEl) return;
  msgEl.textContent = message;
  msgEl.className = `mb-4 p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
  msgEl.classList.remove("hidden");
  setTimeout(() => msgEl.classList.add("hidden"), 3000);
}


  // escapeHtml is now defined at the top of the script


// ------------------ View User Modal ------------------
async function viewUser(userId) {
  console.log('viewUser called with userId:', userId);
  
  if (!userId) {
    console.error('viewUser: No userId provided');
    alert('Error: No user ID provided');
    return;
  }

  console.log('viewUser: Searching in allUsers array, length:', allUsers.length);
  let user = allUsers.find(u => String(u.id) === String(userId));
  console.log('viewUser: Found user in allUsers?', !!user);
  
  // If user not found in allUsers, fetch from API
  if (!user) {
    console.log('viewUser: User not in allUsers, fetching from API...');
    try {
      const apiUrl = `/api/auth/users/${userId}`;
      console.log('viewUser: Fetching from:', apiUrl);
      const response = await fetch(apiUrl, {
        credentials: 'include',
        headers: { 
          'Content-Type': 'application/json',
          ...(currentUser ? { 'x-user-id': currentUser.id } : {}) 
        }
      });

      console.log('viewUser: API response status:', response.status);
      
      if (response.ok) {
        user = await response.json();
        console.log('viewUser: User fetched from API:', user);
        // Add to allUsers array for future use
        if (!allUsers.find(u => String(u.id) === String(userId))) {
          allUsers.push(user);
        }
      } else {
        const data = await response.json().catch(() => ({ message: 'Unknown error' }));
        alert(data.message || 'User not found.');
        console.error('viewUser: Failed to fetch user:', data);
        return;
      }
    } catch (error) {
      console.error('viewUser: Error fetching user:', error);
      alert('Error loading user details: ' + error.message);
      return;
    }
  }

  if (!user) {
    console.error('viewUser: User still not found after API call');
    alert('User not found.');
    return;
  }

  console.log('viewUser: Preparing to display user:', user.name);
  
  const avatarEl = document.getElementById('viewUserAvatar');
  if (!avatarEl) {
    console.error('viewUser: viewUserAvatar element not found!');
    alert('Error: View modal elements not found. Please refresh the page.');
    return;
  }
  if (avatarEl) {
    if (user.avatar || user.profilePicture) {
      avatarEl.style.backgroundImage = `url('${escapeHtml(user.avatar || user.profilePicture)}')`;
      avatarEl.style.backgroundSize = 'cover';
      avatarEl.style.backgroundPosition = 'center';
      avatarEl.textContent = '';
    } else {
      avatarEl.style.backgroundImage = '';
      avatarEl.textContent = (user.name || 'U').charAt(0).toUpperCase();
    }
  }

  try {
    document.getElementById('viewUserName').innerHTML = escapeHtml(user.name || 'N/A');
    const roleSmallEl = document.getElementById('viewUserRoleSmall');
    if (roleSmallEl) {
      roleSmallEl.innerHTML = escapeHtml(user.role || '-');
    }
    document.getElementById('viewUserEmail').innerHTML = escapeHtml(user.email || 'N/A');
    document.getElementById('viewUserContact').innerHTML = escapeHtml(user.contact || 'N/A');
    document.getElementById('viewUserRole').innerHTML = escapeHtml(user.role || '-');
    document.getElementById('viewUserStatus').innerHTML = escapeHtml(user.status || '-');
    document.getElementById('viewUserJoined').innerHTML = escapeHtml(user.joined || (user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'));

    // Button actions
    const editBtn = document.getElementById('viewEditBtn');
    const deleteBtn = document.getElementById('viewDeleteBtn');
    
    if (editBtn) editBtn.onclick = () => { closeViewUserModal(); editUser(userId); };
    if (deleteBtn) deleteBtn.onclick = () => { if(confirm('Delete this user?')) { deleteUser(userId); closeViewUserModal(); } };

    console.log('viewUser: Opening modal...');
    openViewUserModal();
    console.log('viewUser: Modal opened successfully');
  } catch (error) {
    console.error('viewUser: Error setting up modal:', error);
    alert('Error displaying user details: ' + error.message);
  }
}

// Make sure viewUser is accessible globally
window.viewUser = viewUser;

// Test function to verify viewUser is accessible
console.log('viewUser function defined:', typeof viewUser);
console.log('window.viewUser:', typeof window.viewUser);

function openViewUserModal() {
  console.log('openViewUserModal called');
  const modal = document.getElementById('viewUserModal');
  const card = document.getElementById('viewUserModalCard');
  
  if (!modal) {
    console.error('openViewUserModal: Modal element not found!');
    return;
  }
  
  if (!card) {
    console.error('openViewUserModal: Modal card element not found!');
    return;
  }

  console.log('openViewUserModal: Showing modal');
  modal.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');

  const onClick = (ev) => { if (!card.contains(ev.target)) closeViewUserModal(); };
  modal._overlayHandler = onClick;
  modal.addEventListener('click', onClick);

  const onKey = (ev) => { if (ev.key === 'Escape') closeViewUserModal(); };
  modal._keyHandler = onKey;
  document.addEventListener('keydown', onKey);
  
  console.log('openViewUserModal: Modal should now be visible');
}

function closeViewUserModal() {
  const modal = document.getElementById('viewUserModal');
  if (!modal) return;
  modal.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');

  if (modal._overlayHandler) modal.removeEventListener('click', modal._overlayHandler);
  if (modal._keyHandler) document.removeEventListener('keydown', modal._keyHandler);
}

  </script>

<%- include('partials/footer') %>
